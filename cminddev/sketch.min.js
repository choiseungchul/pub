/*!
 * Sketch (2013-02-28, 17:23)
 *
 * Copyright (C) 2011-2013 Hakim El Hattab, http://hakim.se
 */window.sketch={},sketch.IO=function(){function e(e,t){return e||0==e?e:t}var t="/php/sketch.php",n="/php/sketch.php",o="/php/gallery.php",a="x",i=null;return{initialize:function(){i=sketch.Main.linesToJSON()},hasUnsavedChanges:function(){return sketch.Main.linesToJSON()!==i},saveSketch:function(){var e=sketch.Main.linesToJSON();this.hasUnsavedChanges()?e.length>255?$.post(t,"save="+e,function(t){t.match(/error/gi)?alert("Uh-oh, the server replied with a no-no :( Wait a minute and try again."):(i=e,sketch.URL.writeID(t),sketch.Facebook.isConnected()&&FB.api("/me/sketchtoy:draw","post",{sketch:sketch.Main.getSketchShareURL()},function(e){!e||e.error}),sketch.ShareOverlay.show(),sketch.Related.update())}):alert("Please draw more before saving."):sketch.ShareOverlay.show()},loadSketch:function(e,t){$.get(n,{load:e},function(e,n){if(e.match(/error/gi))alert("There was an error loading your sketch."),t("error",{});else{i=e;var n="success";try{var o=sketch.IO.parseSketch($.parseJSON(e))}catch(a){n="error",alert("Uh-oh, an error occured while trying to load this sketch.")}t(n,o)}})},parseSketch:function(t){for(var n=e(t.p,t.perspective),o=e(t.a,t.amplitude),i=e(t.l,t.lines),s=0;i.length>s;s++){i[s].color=e(i[s].c,"#000000"),i[s].thickness=e(i[s].t,i[s].thickness),i[s].perspective=e(i[s].p,i[s].perspective),i[s].dashed=!!e(i[s].d,i[s].dashed),i[s].eraser=!!e(i[s].e,i[s].eraser),i[s].points=e(e(i[s].l,i[s].points),[]);for(var r=i[s].points,c=0;r.length>c;c++){var l={position:{x:0,y:0},normal:{x:0,y:0}};"string"==typeof r[c]?(l.position.x=parseFloat(r[c].slice(0,r[c].indexOf(a))),l.position.y=parseFloat(r[c].slice(r[c].indexOf(a)+1))):(l.position.x=r[c].x,l.position.y=r[c].y),l.normal.x=l.position.x,l.normal.y=l.position.y,r[c]=l}}for(var s=0;i.length>s;s++){var r=i[s].points;0===r.length&&(i.splice(s,1),s--)}return{perspective:n,amplitude:o,lines:i}},loadGalleryItems:function(e,t,n,a){$.get(o,{load:e,start:t,end:n},function(e,t){if(e.match(/error/gi))alert("There was an error loading the sketches.");else{var t="success",n=1,o=[];try{e=$.parseJSON(e),n=e.totalRows;for(var i=0;e.sketches.length>i;i++){var s=s.IO.parseSketch(e.sketches[i].value);s.id=e.sketches[i].id,s.date=e.sketches[i].date,s.views=e.sketches[i].views,o.push(s)}}catch(r){t="error",alert("Uh-oh, an error occured while trying to load the sketches.")}a(t,o,n)}})}}}(),sketch.URL=function(){function e(){return!(!window.history||!history.pushState)}var t="";return{readID:function(){var e=window.location.pathname.split("/")[1];return t.length?t:e.length?e:window.location.hash.slice(1)},writeID:function(n){t=n,e()&&history.pushState({},"Sketch Toy: "+n,"/"+n)}}}(),sketch.Util=function(){return{hexToRGB:function(e){return"string"==typeof e?(e=e.split("#").join(""),{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)}):{r:0,g:0,b:0}},wrapNumber:function(e,t){return e>t?-t+e%t:-t>e?t+e%t:e},distanceBetween:function(e,t){var n=e.x-t.x,o=e.y-t.y;return Math.sqrt(n*n+o*o)},isTouchDevice:function(){return!!navigator.userAgent.match(/ipod|ipad|iphone|android/gi)}}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),sketch.Social=function(){function e(){a||sketch.Util.isTouchDevice()||(a=!0,t(),n())}function t(){$.ajax({url:"//platform.twitter.com/widgets.js",type:"GET",dataType:"script"})}function n(){}function o(e,t,n,o){var a="https://twitter.com/intent/tweet?url="+encodeURIComponent(e)+"&text="+encodeURIComponent(t)+"&related=sketchtoy";o&&(a+="&via="+o),n&&(a+="&hashtags="+n);var i=550,s=420,r=Math.round(screen.width/2-i/2);y=0,screen.height>s&&(y=Math.round(screen.height/2-s/2)),window.open(a,"twitter_share","height="+s+", width="+i+", left="+r+", top="+y+", toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, directories=no, status=no")}var a=!1;return{initialize:e,tweet:o}}(),sketch.Related=function(){function e(){i=$(".related"),s=$(".related-gallery"),r=$(".related-comments"),c||sketch.Util.isTouchDevice()||(c=!0,"/"!==window.location.pathname?(o(),t()):t("horizontal"))}function t(e){s.length&&(s.addClass(e),$.ajax({url:"http://sketch-toy.tumblr.com/api/read/json?callback=?",dataType:"script",context:this,success:function(){"object"==typeof tumblr_api_read&&tumblr_api_read.posts.length&&n(tumblr_api_read.posts)}}))}function n(e){if(e&&s.length){$("<h3>").text("Featured Sketches:").appendTo(s);for(var t="/"===window.location.pathname?6:4,n=0,o=Math.min(e.length,t);o>n;n++){var a=e[n];$(['<a href="'+a["photo-link-url"]+'">','<img src="'+a["photo-url-250"]+'">',"</a>"].join("")).appendTo(s)}}}function o(){r.length&&(r.empty().append("<h3>Comments:</h3>",'<div class="fb-comments" data-href="'+sketch.Main.getSketchShareURL()+'" data-width="500" data-num-posts="3"></div>'),r.addClass("visible"),FB.XFBML.parse(r.get(0)))}function a(){c&&"/"!==window.location.pathname&&o()}var i,s,r,c=!1;return{initialize:e,update:a}}(),sketch.Dropdown={create:function(e){function t(){d.addClass("open"),u.addClass("open"),$(document).on("mousedown",h)}function n(){d.removeClass("open"),u.removeClass("open"),$(document).off("mousedown",h)}function o(e){f=e,d.find(".value").text(e),u.find("button").removeClass("selected"),u.find('button[data-value="'+f+'"]').addClass("selected")}function a(){return f}function i(e){e.preventDefault()}function s(e){e.preventDefault()}function r(e){e.preventDefault();var t=$(e.currentTarget);t.length&&(o(t.attr("data-value")),n(),"function"==typeof this.onChanged&&this.onChanged(f))}function c(){t()}function l(){n()}function h(t){for(var o=t.target,a=!0;o&&o.getAttribute;){if(o&&o==e.get(0)){a=!1;break}o=o.parentNode}a&&n()}var d=e.find(".dropdown-title"),u=e.find(".dropdown-list"),p=u.find("button"),f=null;e.on("mouseover",$.proxy(c,this)),e.on("mouseout",$.proxy(l,this)),d.on("click",$.proxy(i,this)),d.on("mousedown",$.proxy(s,this)),p.on("click",$.proxy(r,this)),this.setValue=o,this.getValue=a}},sketch.Facebook=function(){function e(){g=$(".facebook-send"),w=$(".facebook-share"),$facebookInvite=$(".facebook-invite"),m=$(".facebook-connect"),$facebookContents=$(".facebook-connect .contents"),g.on("click",d),w.on("click",h),$facebookInvite.on("click",u),m.on("click",p),FB.getLoginStatus(function(e){e&&"connected"===e.status?o(null,!0):i(!1)})}function t(e,t){e=e||function(){},FB.getLoginStatus(function(n){"connected"!==n.status||t?FB.login(function(t){t.authResponse?e.call(null,!0):e.call(null,!1)},t):e.call(null,!0)})}function n(e,t){t=t||function(){},FB.api("/me/permissions",function(n){n&&n.data&&n.data.length&&n.data[0][e]?t.call(null,!0):t.call(null,!1)})}function o(e,t){e=e||function(){},n("publish_actions",function(n){n?(i(!0),e.call(null,!0)):t?(i(!1),e.call(null,!1)):FB.login(function(t){t.authResponse?o(null,!0):(i(!1),e.call(null,!1))},{scope:"publish_actions"})})}function a(e){k&&k.id&&FB.api(k.id+"/permissions?permission=publish_actions","delete",{},function(t){!t||t.error?e.call(null,!1):e.call(null,!0)})}function i(e){y=e,$facebookContents.empty(),y?FB.api("/me",{fields:"id,name,first_name,picture"},function(e){if(e){k=e;var t=$('<div class="title">').text("Hello "+e.first_name+"!").appendTo($facebookContents);e.picture&&e.picture.data&&$('<img class="avatar">').attr({src:e.picture.data.url,height:26}).prependTo(t);var n=$('<div class="dropdown">').appendTo($facebookContents);$("<p>").text("Sketches you save are automatically published to your Facebook stream.").appendTo(n),$('<a href="#">').text("Disconnect?").appendTo(n).on("click",f)}m.removeClass("loading").addClass("connected")}):m.removeClass("loading").removeClass("connected")}function s(e,t,n){FB.ui({method:"send",name:t,link:e,description:n})}function r(e,t,n){FB.ui({method:"feed",name:t,link:e,description:n})}function c(){function e(){v&&v.abort();var e=new FormData;e.append("file",i),e.append("access_token",FB.getAccessToken()),e.append("message","Replay: "+sketch.Main.getSketchShareURL()),v=$.ajax({url:"https://graph.facebook.com/me/photos",data:e,type:"POST",cache:!1,contentType:!1,processData:!1,timeout:3e4,statusCode:{400:function(){a()},401:function(){a()},403:function(){a()},500:function(){a()}},complete:function(e,t){var n;try{n=$.parseJSON(e.responseText)}catch(i){a(t)}n&&0===n.success?a():"OK"===e.statusText&&n&&n.id?o():a()}})}function o(){sketch.LoadingOverlay.hideSuccess("Photo uploaded!"),sketch.Main.trackEvent("Facebook","Photo Upload Success")}function a(){sketch.LoadingOverlay.hideError("Failed to upload photo"),sketch.Main.trackEvent("Facebook","Photo Upload Error")}sketch.LoadingOverlay.show("Uploading photo...");var i=sketch.Main.getSketchAsBlob();i&&n("publish_actions",function(n){n&&FB.getAccessToken()?e():t(function(t){t?e():(sketch.LoadingOverlay.hide(),sketch.Main.trackEvent("Facebook","Photo Upload Cancel"))},{scope:"publish_actions"})})}function l(){return y}function h(e){sketch.URL.readID()?sketch.Facebook.share(sketch.Main.getSketchShareURL(),"An animated sketch! Click to replay.","Sketch Toy lets you draw animated sketches and share replays with friends."):sketch.Facebook.share(window.location.protocol+"//"+window.location.host+"/","Sketch Toy","Draw animated sketches and share replays with friends!"),sketch.Main.trackEvent("Toolbar","Facebook Share"),e.preventDefault()}function d(e){sketch.URL.readID()?sketch.Facebook.send(sketch.Main.getSketchShareURL(),"An animated sketch! Click to replay.","Sketch Toy lets you draw animated sketches and share replays with friends."):sketch.Facebook.send(window.location.protocol+"//"+window.location.host+"/","Sketch Toy","Draw animated sketches and share replays with friends!"),sketch.Main.trackEvent("Toolbar","Facebook Send"),e.preventDefault()}function u(e){FB.ui({method:"apprequests",message:"Sketch with me",filters:[]},function(e){return e&&e.to?(sketch.Main.trackEvent("Header","Facebook Invite Sent"),void 0):(sketch.Main.trackEvent("Header","Facebook Invite Cancel"),!1)}),sketch.Main.trackEvent("Header","Facebook Invite"),e.preventDefault()}function p(e){m.hasClass("loading")||m.hasClass("connected")||(l()||sketch.Facebook.login(function(e){e?o(null,!0):i(!1)},{scope:"publish_actions"}),sketch.Main.trackEvent("Header","Facebook Connect")),e.preventDefault()}function f(e){a(function(e){e&&i(!1)}),sketch.Main.trackEvent("Header","Facebook Disconnect"),e.preventDefault()}var k,v,g,w,m,y=!1;return{initialize:e,login:t,send:s,share:r,upload:c,connect:o,isConnected:l}}(),sketch.ShareOverlay=function(){function e(){u.val(sketch.Main.getSketchShareURL());var e=encodeURIComponent("An animated sketch"),t=encodeURIComponent("Check out this sketch: "+sketch.Main.getSketchShareURL());p.attr("href","mailto:?body="+t+"&subject="+e)}function t(e){e.preventDefault(),sketch.ShareOverlay.hide()}function n(e){e.target===d.get(0)&&(e.preventDefault(),sketch.ShareOverlay.hide())}function o(e){e.preventDefault(),u.select()}function a(e){e.preventDefault(),sketch.Facebook.share(sketch.Main.getSketchShareURL(),k),sketch.Main.trackEvent("Share","Facebook")}function i(e){e.preventDefault(),sketch.Facebook.send(sketch.Main.getSketchShareURL(),k),sketch.Main.trackEvent("Share","Facebook Message")}function s(e){e.preventDefault(),sketch.Facebook.upload(),sketch.Main.trackEvent("Share","Facebook Photo")}function r(e){e.preventDefault(),sketch.Social.tweet(sketch.Main.getSketchShareURL(),f,"sketchtoy","sketchtoy"),sketch.Main.trackEvent("Share","Twitter")}function c(){sketch.Main.trackEvent("Share","Email")}function l(e){e.preventDefault(),sketch.Main.saveSketchAsImage(),sketch.Main.trackEvent("Share","Download")}function h(e){27===e.keyCode&&(e.preventDefault(),sketch.ShareOverlay.hide())}var d=$(".share-overlay"),u=d.find(".url input"),p=d.find(".share-email"),f="",k="";return d.find(".close").on("click",t),d.find(".share-facebook").on("click",a),d.find(".share-facebook-message").on("click",i),d.find(".share-facebook-photo").on("click",s),d.find(".share-twitter").on("click",r),d.find(".share-email").on("click",c),d.find(".share-download").on("click",l),d.on("click",n),u.on("click",o),{show:function(){d.toggleClass("empty",sketch.Main.isEmpty()),d.show(),sketch.Main.isEmpty()?(k="Sketch Toy",f="Sketch using animated lines and share replays with friends!"):(k="An animated sketch! Click to replay.",f="Check out this drawing!"),e(),u.select(),$(document).on("keydown",h)},hide:function(){d.hide(),$(document).off("keydown",h)}}}(),sketch.LoadingOverlay=function(){var e=$(".loading-overlay");return e.find(".status"),loadingMessage=e.find(".message"),timeout=-1,{show:function(t){clearTimeout(timeout),e.show(),e.removeClass("success-state error-state").addClass("loading-state"),loadingMessage.text(t||"")},hide:function(){clearTimeout(timeout),e.hide()},hideSuccess:function(t){e.removeClass("loading-state error-state").addClass("success-state"),loadingMessage.text(t||""),clearTimeout(timeout),timeout=setTimeout(sketch.LoadingOverlay.hide,2e3)},hideError:function(t){e.removeClass("success-state loading-state").addClass("error-state"),loadingMessage.text(t||""),clearTimeout(timeout),timeout=setTimeout(sketch.LoadingOverlay.hide,3e3)}}}(),sketch.Main=function(){function e(e){$(document.body).addClass("loading"),sketch.IO.loadSketch(e,function(e,n){$(document.body).removeClass("loading"),"success"==e?(n.perspective&&(yt=n.perspective,kt=n.perspective),n.amplitude&&(vt=n.amplitude,vibrationDropdown.setValue(Math.round(n.amplitude/W))),ht=n.lines,ut=!0,t()):lt=[]})}function t(e){var n=0;e:for(var o=0;ht.length>o;o++){lt[o]=lt[o]||{color:ht[o].color,thickness:ht[o].thickness,perspective:ht[o].perspective,dashed:ht[o].dashed,eraser:ht[o].eraser,points:[]},ft=lt[o].perspective;for(var a=ht[o].points;a.length;)if(p=a.shift(),lt[o].points.push(p),!e&&!lt[o].eraser&&o%2&&h(p.position.x,p.position.y,2,lt[o].perspective,lt[o].color),!e&&n++>at)break e}var i=ht[ht.length-1];i&&i.points.length&&!e?(ut=!0,setTimeout(function(){t()},ot)):e?(ut=!1,yt=kt,ft=kt):(pt=!0,ft=kt)}function n(){t(!0)}function o(){if(!navigator.userAgent.match(/ipod|ipad|iphone|android/gi)){var e=!1;try{e="localStorage"in window&&null!==window.localStorage}catch(t){e=!1}}}function a(){colorDropdown=new sketch.Dropdown.create($(".color-dropdown")),colorDropdown.setValue(wt),colorDropdown.onChanged=function(e){i(e),J.trackEvent("Toolbar","Color",e)},$(".color-dropdown .dropdown-title").text("Color"),sizeDropdown=new sketch.Dropdown.create($(".size-dropdown")),sizeDropdown.setValue(mt),sizeDropdown.onChanged=function(e){J.trackEvent("Toolbar","Size",e)},vibrationDropdown=new sketch.Dropdown.create($(".vibration-dropdown")),vibrationDropdown.setValue(1),vibrationDropdown.onChanged=function(e){vt=W*e,J.trackEvent("Toolbar","Vibration",e)}}function i(e){var t=$(".color-dropdown .dropdown-title"),n=sketch.Util.hexToRGB(e);t.toggleClass("light",n.r+n.g>500||n.r+n.b>500||n.b+n.g>500),t.css({"background-color":e,"box-shadow":"2px 2px 1px rgba("+n.r+","+n.g+","+n.b+",0.4)"}).text("Color")}function s(){Dt=j.offset(),Dt.left-=$(window).scrollLeft(),Dt.top-=$(window).scrollTop()}function r(e){c();var t=$('<div class="stencil" style="background-image: url('+e+')">').appendTo(H),n=$('<div class="stencil-controls">').text("Background image: ").appendTo(H),o=$('<a class="stencil-button toggle" href="#">Hide</a>').appendTo(n),a=$('<a class="stencil-button clear" href="#">Remove</a>').appendTo(n);setTimeout(function(){t.addClass("visible")},200),o.on("click",function(e){e.preventDefault(),t.toggleClass("visible"),o.text(t.hasClass("visible")?"Hide":"Show")}),a.on("click",function(e){e.preventDefault(),c()}),$("html").addClass("has-stencil")}function c(){H.find(".stencil, .stencil-controls").remove(),$("html").removeClass("has-stencil")}function l(e){St.press.x=St.x,St.press.y=St.y,e.target==V&&(ut&&n(!0),mt=sizeDropdown.getValue()||Q,wt=colorDropdown.getValue()||Z,lt.push({color:wt,thickness:mt,perspective:yt,dashed:Tt,eraser:$t,points:[]}),e.preventDefault(),Mt===!1&&(Mt=!0,sketch.Main.trackEvent("Canvas","Drew First Line")))}function h(e,t,n,o,a){for(var i=Math.round(Math.random()*n);i--;)ct.push({position:{x:e,y:t},velocity:{x:.5*Math.random()-.25,y:3*Math.random()},alpha:.98,perspective:o,color:a||"#000000"})}function d(){Ft.eraserToggle.toggleClass("on"),$t=Ft.eraserToggle.hasClass("on")}function u(){requestAnimFrame(u),q.clearRect(0,0,V.width,V.height),q.save(),q.scale(st.scale,st.scale),f(),k(),q.restore()}function f(){var e=999,t=lt[lt.length-1];if(t){var o=t.points[t.points.length-1];o&&(e=sketch.Util.distanceBetween(St,o.position))}ut&&(yt+=.08*(ft-yt),kt==ft&&.003>Math.abs(yt-ft)&&pt&&(yt=kt,n())),yt=sketch.Util.wrapNumber(yt+bt,1),bt*=.8,(Ct.spaceDown||Ct.leftDown||Ct.rightDown)&&(xt=1),St.down&&Ct.spaceDown?bt+=St.diff.x/st.width:Ct.leftDown&&!Ct.rightDown?bt-=.005:Ct.rightDown&&!Ct.leftDown?bt+=.005:St.down&&Math.abs(e)>nt&&(t.points.push({position:{x:St.x,y:St.y},normal:{x:St.x,y:St.y}}),dt++,$t||h(St.x,St.y,5,yt,wt)),St.diff.x=0,St.diff.y=0}function k(){for(var e=lt.length,t=0;e>t;t++){var n=lt[t].color||"#000000",o=lt[t].thickness,a=sketch.Util.wrapNumber(2*(yt-lt[t].perspective),2),i=lt[t].dashed,s=lt[t].eraser,r=lt[t].points,c=r.length,l=r[0],h=r[1];if(s&&(q.save(),q.globalCompositeOperation="destination-out"),c>1){i||q.beginPath();for(var d=1,u=r.length;u>d;d++){i&&q.beginPath(),1>sketch.Util.distanceBetween(l.position,l.normal)&&(l.position.x+=(Math.random()-.5)*vt,l.position.y+=(Math.random()-.5)*vt),l.position.x+=(l.normal.x-l.position.x)*gt,l.position.y+=(l.normal.y-l.position.y)*gt;var p=l.position.x,f=h.position.x;p+=a*(l.position.x-.5*G)*(0>a?1:-1),f+=a*(h.position.x-.5*G)*(0>a?1:-1),(1==d||i)&&q.moveTo(p,l.position.y),q.quadraticCurveTo(p,l.position.y,p+(f-p)/2,l.position.y+(h.position.y-l.position.y)/2),l=r[d],h=r[d+1],i&&v(o,n)}i||(v(o,n),q.closePath())}else 1===c&&(l.position.x+=(Math.random()-.5)*vt,l.position.y+=(Math.random()-.5)*vt,l.position.x+=(l.normal.x-l.position.x)*gt,l.position.y+=(l.normal.y-l.position.y)*gt,g(l.position.x+a*(l.position.x-.5*G)*(0>a?1:-1),l.position.y,o/2,n));s&&q.restore()}for(var d=0;ct.length>d;d++){var k=ct[d],a=sketch.Util.wrapNumber(2*(yt-k.perspective),2);k.position.x+=k.velocity.x,k.position.y+=k.velocity.y;var w=k.position.x;w+=a*(k.position.x-.5*st.width)*(0>a?1:-1),k.alpha*=.94;var m={r:0,g:0,b:0};k.color&&(m=sketch.Util.hexToRGB(k.color)),q.fillStyle="rgba("+m.r+","+m.g+","+m.b+","+k.alpha+")",q.fillRect(w,k.position.y,1,1),.05>k.alpha&&(ct.splice(d,1),d--)}if(xt>0){q.save(),q.globalAlpha=Math.max(xt,0),q.beginPath(),q.scale(1,.5);for(var y=yt*Math.PI-Math.PI/2,d=0;2>d;d++){var b=0==d?tt:0;q.moveTo(G/2,1.7*X+2),q.arc(G/2,1.7*X+b,et,y-.2,y+.2,!0),q.closePath(),q.lineWidth=4,q.strokeStyle="rgb(165,106,70)",q.stroke(),q.fillStyle="rgba(240,150,105,0.85)",q.fill(),q.beginPath()}q.restore(),xt-=.05}if(St.over){var m=sketch.Util.hexToRGB($t?"#000000":colorDropdown.getValue()||Z);q.beginPath(),q.arc(St.x,St.y,(sizeDropdown.getValue()||Q)/2,0,2*Math.PI,!0),q.closePath(),q.fillStyle="rgba("+m.r+","+m.g+","+m.b+",0.4)",q.fill()}}function v(e,t){q.lineCap="round",q.lineJoin="round",q.lineWidth=e,q.strokeStyle=t,q.stroke()}function g(e,t,n,o){q.beginPath(),q.arc(e,t,n,0,2*Math.PI,!0),q.fillStyle=o,q.fill(),q.closePath()}function w(e){e.preventDefault(),J.saveSketch(),J.trackEvent("Toolbar","Save/Share")}function m(e){e.preventDefault(),ut&&n(!0),lt.length?J.saveSketch():sketch.ShareOverlay.show(),J.trackEvent("Toolbar","Share")}function y(e){e.preventDefault(),lt.pop(),J.trackEvent("Toolbar","Undo")}function b(e){(!sketch.IO.hasUnsavedChanges()||confirm("Are you sure you want to clear the drawing?"))&&(lt.length>0,ht=[],lt=[],ct=[],sketch.URL.writeID(""),dt=0,J.trackEvent("Toolbar","Reset")),e.preventDefault()}function x(e){if(!sketch.IO.hasUnsavedChanges()||confirm("The current drawing will be lost, do you want to continue?")){var t=lt.length>0;ht=[],lt=[],ct=[],sketch.URL.writeID(""),dt=0,J.trackEvent("Toolbar","New"),t&&(window.location="/")}e.preventDefault()}function D(e){Ft.dashToggle.toggleClass("on"),Tt=Ft.dashToggle.hasClass("on"),J.trackEvent("Toolbar","Dash",Tt?1:0),e.preventDefault()}function S(e){d(),J.trackEvent("Toolbar","Eraser",$t?1:0),e.preventDefault()}function C(e){e.preventDefault(),sketch.Social.tweet(sketch.Main.getSketchShareURL(),"Check out this sketch","sketchtoy"),sketch.Main.trackEvent("Toolbar","Tweet")}function T(e){switch(e.keyCode){case 32:Ct.spaceDown=!0,e.preventDefault();break;case 37:Ct.leftDown=!0,e.preventDefault();break;case 39:Ct.rightDown=!0,e.preventDefault();break;case 69:d(),e.preventDefault();break;case 90:(e.ctrlKey||e.metaKey)&&lt.pop()}ut&&n()}function M(e){switch(e.keyCode){case 32:Ct.spaceDown=!1,e.preventDefault();break;case 37:Ct.leftDown=!1,e.preventDefault();break;case 39:Ct.rightDown=!1,e.preventDefault()}}function F(e){St.down=!0,s(),St.x=(e.clientX-Dt.left)/st.scale,St.y=(e.clientY-Dt.top)/st.scale,l(e)}function E(e){St.over&&s(),St.prev.x=St.x,St.prev.y=St.y,St.x=(e.clientX-Dt.left)/st.scale,St.y=(e.clientY-Dt.top)/st.scale,St.diff.x=St.x-St.prev.x,St.diff.y=St.y-St.prev.y}function U(e){St.down=!1,St.x=(e.clientX-Dt.left)/st.scale,St.y=(e.clientY-Dt.top)/st.scale}function L(){s(),St.over=!0}function R(){St.over=!1}function B(e){1==e.touches.length&&"CANVAS"===e.target.nodeName&&(St.down=!0,Dt=j.offset(),Dt.left+=10,Dt.top-=$(window).scrollTop()-10,St.x=(e.touches[0].pageX-Dt.left)/st.scale,St.y=(e.touches[0].pageY-Dt.top)/st.scale,l(e),e.preventDefault())}function I(e){1==e.touches.length&&(e.preventDefault(),St.prev.x=St.x,St.prev.y=St.y,St.x=(e.touches[0].pageX-Dt.left)/st.scale,St.y=(e.touches[0].pageY-Dt.top)/st.scale,St.diff.x=St.x-St.prev.x,St.diff.y=St.y-St.prev.y)}function O(){St.down=!1}function A(e){if(e||(e=window.event),dt>4){var t="Your current drawing will be lost.";return e.cancelBubble=!0,e.returnValue=t,e.stopPropagation&&(e.stopPropagation(),e.preventDefault()),t}}function P(){setTimeout(function(){sketch.Social.initialize()},500),setTimeout(function(){sketch.Related.initialize()},500)}function z(){var e=it&&(sketch.Util.isTouchDevice()||1250>window.innerWidth);$("html").toggleClass("scyscrapes-below",e),rt.width=Math.max(window.innerWidth,Y),rt.height=window.innerHeight,st.scale=1,st.width=G*st.scale,st.height=X*st.scale,V.width=st.width,V.height=st.height,H.width(st.width).height(st.height),st.x=j.position().left,st.y=j.position().top,Ft.spinner.css({top:st.y+(st.height/2-16)}),Ft.toolbar.width(st.width),$(".sketch-canvas-wrapper").css("width",e?st.width:"initial"),$(".sketch-footer").css({left:st.x,width:st.width})}function _(e){e.preventDefault();var t=e.dataTransfer.files;if(t.length){var n=new FileReader;n.onloadend=N,n.readAsDataURL(t[0])}}function N(e){e.target.result.match(/^data:image/gi)?r(e.target.result):alert("Doesn't seem like that's an image. Please try another file.")}var V,q,j,H,J={},Y=760,G=960,X=580,W=3,K=.7,Q=3,Z="#000000",et=50,tt=6,nt=4,ot=20,at=2,it=!(!$("#left-pillar").length||!$("#right-pillar").length),st={x:0,y:0,scale:1,width:G,height:X},rt={width:0,height:0},ct=[],lt=[],ht=[],dt=0,ut=!1,pt=!1,ft=0,kt=0,vt=W,gt=K,wt=Z,mt=Q,yt=0,bt=0,xt=0,Dt={x:0,y:0},St={x:0,y:0,prev:{x:0,y:0},diff:{x:0,y:0},press:{x:0,y:0},down:!1,over:!1},Ct={spaceDown:!1,leftDown:!1,rightDown:!1},Tt=!1,$t=!1,Mt=!1,Ft={toolbar:null,saveButton:null,resetButton:null,dashToggle:null,vibrationDropdown:null,sizeDropdown:null,facebookConnect:null};return J.initialize=function(){if(H=$(".sketch-canvas-container"),j=$(".sketch-canvas"),V=j.get(0),Ft.spinner=$("#spinner"),Ft.toolbar=$(".toolbar"),Ft.saveButton=$(".toolbar .save-button"),Ft.undoButton=$(".toolbar .undo-button"),Ft.newButton=$(".toolbar .new-button"),Ft.resetButton=$(".toolbar .reset-button"),Ft.dashToggle=$(".toolbar .dash-toggle"),Ft.eraserToggle=$(".toolbar .eraser-toggle"),Ft.shareButton=$(".toolbar .share-button"),Ft.tweetButton=$(".toolbar .tweet-button"),a(),o(),sketch.IO.initialize(),V&&V.getContext){q=V.getContext("2d"),V.addEventListener("mousedown",F,!1),document.addEventListener("mousemove",E,!1),document.addEventListener("mouseup",U,!1),V.addEventListener("touchstart",B,!1),V.addEventListener("touchmove",I,!1),document.addEventListener("touchend",O,!1),document.addEventListener("keydown",T,!1),document.addEventListener("keyup",M,!1),document.addEventListener("dragover",function(e){e.preventDefault()},!1),document.addEventListener("dragenter",function(e){e.preventDefault()},!1),document.addEventListener("dragexit",function(e){e.preventDefault()},!1),document.addEventListener("drop",_,!1),Ft.saveButton.on("click",w),Ft.shareButton.on("click",m),Ft.undoButton.on("click",y),Ft.newButton.on("click",x),Ft.resetButton.on("click",b),Ft.dashToggle.on("click",D),Ft.eraserToggle.on("click",S),Ft.tweetButton.on("click",C),window.addEventListener("resize",z,!1),window.addEventListener("beforeunload",A,!1),$(window).on("load",P),z(),Ft.toolbar.css("display","inline-block"),sketch.Util.isTouchDevice()?$("html").addClass("touch"):(j.on("mouseover",L),j.on("mouseout",R)),"undefined"!=typeof chrome&&chrome.app&&chrome.app.isInstalled?$("html").addClass("chrome-app-installed"):navigator.userAgent.match(/chrome/gi)&&$("html").addClass("chrome-app-capable"),$("html").addClass("initialized"),u();var t=sketch.URL.readID();t.length>=1&&e(t)}},J.trackEvent=function(e,t,n){_gaq.push(["_trackEvent",e,t,n])},J.displayError=function(e){alert(e)},J.getSketchShareURL=function(){return window.location.protocol+"//"+window.location.host+"/"+sketch.URL.readID()},J.isEmpty=function(){return 0===lt.length},J.linesToJSON=function(){for(var e=0;lt.length>e;e++)lt[e]&&lt[e].points&&0!=lt[e].points.length||(lt.splice(e,1),e--);var t="{";t+='"p":'+yt.toFixed(6)+",",t+='"a":'+vt.toFixed(6)+",",t+='"l":[';for(var e=0;lt.length>e;e++){var n=lt[e].points;t+="{",t+='"t":'+lt[e].thickness+",",t+='"p":'+(0==lt[e].perspective?"0.000100":lt[e].perspective.toFixed(6))+",",t+='"d":'+(lt[e].dashed?1:0)+",",t+='"e":'+(lt[e].eraser?1:0)+",",lt[e].color&&"#000000"!==lt[e].color&&(t+='"c":"'+lt[e].color+'",'),t+='"points":[';for(var o=0;n.length>o;o++){var a=n[o],i=Math.round(a.normal.x),s=Math.round(a.normal.y);t+='"'+i+"x"+s+'"',t+=n.length-1>o?",":""}t+="]}",t+=lt.length-1>e?",":""}return t+="]}"},J.saveSketch=function(){lt.length>0?(sketch.IO.saveSketch(),dt=0):alert("You need to draw something to save.")},J.saveSketchAsImage=function(){q.save(),q.globalCompositeOperation="destination-over",q.fillStyle="#fff",q.fillRect(0,0,st.width,st.height),q.restore();var e=V.toDataURL("image/png"),t=window.open("about:blank","Your Sketch");t.document.write("<img src='"+e+"' />")},J.getSketchAsBlob=function(){var e=V.toDataURL("image/png");if(!e||!window.Blob||!window.atob)return null;var t,n=window.atob(e.split(",")[1]),o=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(n.length),i=new Uint8Array(a);for(t=n.length;t--;)i[t]=n.charCodeAt(t);try{if(window.DataView)return new Blob([new DataView(a)],{type:o})}catch(s){}try{return new Blob([i],{type:o})}catch(s){}return null},J}(),sketch.Main.initialize();